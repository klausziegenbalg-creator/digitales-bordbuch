<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Reinigungsprotokoll Zuckerwatte Automaten</title>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 10px 20px 40px;
      background: linear-gradient(180deg, #e3f2fd 0%, #f5f5f7 40%, #ffffff 100%);
      font-size: 18px;
    }

    h1 {
      font-size: 30px;
      margin-bottom: 10px;
      color: #1a237e;
    }

    .section {
      margin: 12px 0;
      padding: 16px 20px;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      border-left: 4px solid #42a5f5;
    }

    .section h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 20px;
      color: #0d47a1;
    }

    select, input, textarea {
      padding: 10px 12px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
      font-size: 18px;
    }

    label, td {
      font-size: 18px;
    }

    table.task-table {
      width: 100%;
      border-collapse: collapse;
    }

    table.task-table td {
      padding: 3px 4px;
      vertical-align: middle;
    }

    /* Zwei Spalten f√ºr Aufgaben / Funktionspr√ºfung */
    table.task-table.two-cols td {
      width: 50%;
      vertical-align: top;
    }

    .chk-cell {
      width: 34px;
      text-align: left;
      white-space: nowrap;
    }

    .chk-cell input[type="checkbox"] {
      transform: scale(1.4);
      margin: 0 4px 0 0;  /* sehr kleiner Abstand zum Text */
    }

    button {
      background: #1e88e5;
      color: white;
      padding: 12px 26px;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      margin-top: 14px;
    }

    button:hover {
      background: #1565c0;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .success {
      background: #34a853;
      color: white;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>üßπ Reinigungsprotokoll Zuckerwatte Automaten</h1>

  <div class="section">
    <h3>1. Automat ausw√§hlen</h3>
    <select id="stadtSelect"><option>W√§hle Stadt...</option></select>
    <select id="centerSelect" disabled><option>W√§hle Center...</option></select>
    <select id="automatSelect" disabled><option>W√§hle Automat...</option></select>
    <input type="date" id="datum" />
    <select id="mitarbeiterSelect" disabled><option>Mitarbeiter w√§hlen...</option></select>
  </div>

  <div class="section">
    <h3>2. Aufgaben pro Automat</h3>
    <table class="task-table two-cols">
      <tr>
        <td>
          <table class="task-table">
            <tr><td class="chk-cell"><input type="checkbox" id="zucker"></td><td>Zucker auff√ºllen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="staebe"></td><td>St√§be auff√ºllen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="faecher"></td><td>Alle F√§cher reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="produktionsraum"></td><td>Produktionsraum reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="roboterarm"></td><td>Roboterarm gr√ºndlich reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="auffangschale"></td><td>Auffangschale reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="aussen"></td><td>Automat au√üen reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="brennerkopf"></td><td>Brennerkopf reinigen</td></tr>
          </table>
        </td>
        <td>
          <table class="task-table">
            <tr><td class="chk-cell"><input type="checkbox" id="wasser"></td><td>Wasser auff√ºllen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="zuckerfach"></td><td>Zuckerfach reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="abwasser"></td><td>Abwasser entleeren</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="messer"></td><td>Messer + R√§dchen reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="sieb"></td><td>Sieb oben reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="aufbewahrung"></td><td>Aufbewahrungsfach aufr√§umen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="scheiben"></td><td>Scheiben reinigen</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="duese"></td><td>D√ºse hinter Brennerkopf reinigen</td></tr>
          </table>
        </td>
      </tr>
    </table>
  </div>

  <div class="section">
    <h3>3. Best√§nde (angefangen ‚â• 50% = 0,5)</h3>
    <table class="task-table">
      <tr>
        <td>Roter Zucker:</td>
        <td><input type="number" id="zucker_rot" step="0.5" min="0" max="10" /></td>
        <td>Gelber Zucker:</td>
        <td><input type="number" id="zucker_gelb" step="0.5" min="0" max="10" /></td>
      </tr>
      <tr>
        <td>Blauer Zucker:</td>
        <td><input type="number" id="zucker_blau" step="0.5" min="0" max="10" /></td>
        <td>Wei√üer Zucker:</td>
        <td><input type="number" id="zucker_weiss" step="0.5" min="0" max="10" /></td>
      </tr>
      <tr>
        <td>Weinrot:</td>
        <td><input type="number" id="zucker_weinrot" step="0.5" min="0" max="10" /></td>
        <td>Gr√ºn:</td>
        <td><input type="number" id="zucker_gruen" step="0.5" min="0" max="10" /></td>
      </tr>
    </table>
  </div>

  <div class="section">
    <h3>4. Funktionspr√ºfung</h3>
    <table class="task-table two-cols">
      <tr>
        <td>
          <table class="task-table">
            <tr><td class="chk-cell"><input type="checkbox" id="befuchtung"></td><td>Befeuchtungstest</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="stabgenommen"></td><td>Automat. neuen Stab genommen</td></tr>
          </table>
        </td>
        <td>
          <table class="task-table">
            <tr><td class="chk-cell"><input type="checkbox" id="reinigungstest"></td><td>Reinigungstest</td></tr>
            <tr><td class="chk-cell"><input type="checkbox" id="roboterwinkel"></td><td>Roboterarm 90¬∞ Winkel</td></tr>
          </table>
        </td>
      </tr>
    </table>
    <label>Auff√§lligkeiten:
      <textarea id="auffaelligkeiten" rows="3" placeholder="Alles ok oder Probleme notieren..."></textarea>
    </label>
  </div>

  <button id="speichernBtn" disabled onclick="speichernProtokoll()">‚úÖ Protokoll speichern</button>
  <div id="status"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBo-pt3krDP9c5AxojmWaHVqPkoqmupOvA",
      authDomain: "digitales-bordbuch.firebaseapp.com",
      projectId: "digitales-bordbuch",
      storageBucket: "digitales-bordbuch.firebasestorage.app",
      messagingSenderId: "612073997080",
      appId: "1:612073997080:web:762cec6c160eab6f84546d",
      measurementId: "G-509LRCRV66"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const stadtSelect = document.getElementById('stadtSelect');
    const centerSelect = document.getElementById('centerSelect');
    const automatSelect = document.getElementById('automatSelect');
    const mitarbeiterSelect = document.getElementById('mitarbeiterSelect');
    const datumInput = document.getElementById('datum');
    const speichernBtn = document.getElementById('speichernBtn');
    const statusDiv = document.getElementById('status');

    const heute = new Date().toISOString().split('T')[0];
    datumInput.value = heute;

    function clearSelect(select) {
      select.innerHTML = '';
    }

    function addOption(select, text, value) {
      const option = document.createElement('option');
      option.textContent = text;
      option.value = value;
      select.appendChild(option);
    }

    async function ladeStaedte() {
      clearSelect(stadtSelect);
      addOption(stadtSelect, 'W√§hle Stadt...', '');

      const snapshot = await db.collection('automaten').get();

      const staedteSet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.stadt) {
          staedteSet.add(String(data.stadt).trim());
        }
      });

      const staedte = Array.from(staedteSet).sort();
      staedte.forEach(stadt => addOption(stadtSelect, stadt, stadt));

      stadtSelect.disabled = false;
      centerSelect.disabled = true;
      automatSelect.disabled = true;
      mitarbeiterSelect.disabled = true;
      speichernBtn.disabled = true;
    }

    async function ladeCenter(stadt) {
      clearSelect(centerSelect);
      addOption(centerSelect, 'W√§hle Center...', '');

      centerSelect.disabled = true;
      automatSelect.disabled = true;
      mitarbeiterSelect.disabled = true;
      speichernBtn.disabled = true;

      if (!stadt) return;

      const snapshot = await db.collection('automaten')
        .where('stadt', '==', stadt)
        .get();

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.center) {
          addOption(centerSelect, String(data.center), String(data.center));
        }
      });

      if (centerSelect.options.length > 1) {
        centerSelect.disabled = false;
      }
    }

    async function ladeAutomatenUndMitarbeiter(stadt, center) {
      clearSelect(automatSelect);
      addOption(automatSelect, 'W√§hle Automat...', '');
      clearSelect(mitarbeiterSelect);
      addOption(mitarbeiterSelect, 'Mitarbeiter w√§hlen...', '');

      automatSelect.disabled = true;
      mitarbeiterSelect.disabled = true;
      speichernBtn.disabled = true;

      if (!stadt || !center) return;

      const snapshot = await db.collection('automaten')
        .where('stadt', '==', stadt)
        .where('center', '==', center)
        .get();

      const mitarbeiterSet = new Set();

      snapshot.forEach(doc => {
        const data = doc.data();

        const code = (data.automatCode || data.Automat || "").toString().trim();
        if (code) {
          addOption(automatSelect, code, code);
        }

        if (data.mitarbeiter) {
          mitarbeiterSet.add(String(data.mitarbeiter).trim());
        }
      });

      const mitarbeiterListe = Array.from(mitarbeiterSet).sort();
      mitarbeiterListe.forEach(m => addOption(mitarbeiterSelect, m, m));

      if (automatSelect.options.length > 1) {
        automatSelect.disabled = false;
      }
      if (mitarbeiterSelect.options.length > 1) {
        mitarbeiterSelect.disabled = false;
      }
    }

    function pruefeFormular() {
      const stadt = stadtSelect.value;
      const center = centerSelect.value;
      const automat = automatSelect.value;
      const mitarbeiter = mitarbeiterSelect.value;
      const datum = datumInput.value;

      speichernBtn.disabled = !(stadt && center && automat && mitarbeiter && datum);
    }

    stadtSelect.addEventListener('change', async () => {
      await ladeCenter(stadtSelect.value);
      pruefeFormular();
    });

    centerSelect.addEventListener('change', async () => {
      await ladeAutomatenUndMitarbeiter(stadtSelect.value, centerSelect.value);
      pruefeFormular();
    });

    automatSelect.addEventListener('change', pruefeFormular);
    mitarbeiterSelect.addEventListener('change', pruefeFormular);
    datumInput.addEventListener('change', pruefeFormular);

    async function speichernProtokoll() {
      if (speichernBtn.disabled) return;

      speichernBtn.disabled = true;
      statusDiv.textContent = 'Speichere...';
      statusDiv.className = '';

      try {
        const data = {
          automatCode: automatSelect.value,
          stadt: stadtSelect.value,
          center: centerSelect.value,
          datum: new Date(datumInput.value),
          mitarbeiter: mitarbeiterSelect.value,
          zucker_aufgefuellt: document.getElementById('zucker').checked,
          wasser_aufgefuellt: document.getElementById('wasser').checked,
          staebe_aufgefuellt: document.getElementById('staebe').checked,
          zuckerfach_reinigen: document.getElementById('zuckerfach').checked,
          faecher_reinigen: document.getElementById('faecher').checked,
          abwasser_entleeren: document.getElementById('abwasser').checked,
          produktionsraum_reinigen: document.getElementById('produktionsraum').checked,
          messer_reinigen: document.getElementById('messer').checked,
          roboterarm_reinigen: document.getElementById('roboterarm').checked,
          sieb_reinigen: document.getElementById('sieb').checked,
          auffangschale_reinigen: document.getElementById('auffangschale').checked,
          aufbewahrung_aufr√§umen: document.getElementById('aufbewahrung').checked,
          automat_aeusserlich_reinigen: document.getElementById('aussen').checked,
          scheiben_reinigen: document.getElementById('scheiben').checked,
          brennerkopf_reinigen: document.getElementById('brennerkopf').checked,
          duese_reinigen: document.getElementById('duese').checked,
          zucker_rot: parseFloat(document.getElementById('zucker_rot').value) || 0,
          zucker_gelb: parseFloat(document.getElementById('zucker_gelb').value) || 0,
          zucker_blau: parseFloat(document.getElementById('zucker_blau').value) || 0,
          zucker_weiss: parseFloat(document.getElementById('zucker_weiss').value) || 0,
          zucker_weinrot: parseFloat(document.getElementById('zucker_weinrot').value) || 0,
          zucker_gruen: parseFloat(document.getElementById('zucker_gruen').value) || 0,
          befeuchtungstest: document.getElementById('befuchtung').checked,
          reinigungstest: document.getElementById('reinigungstest').checked,
          stabgenommen: document.getElementById('stabgenommen').checked,
          roboterwinkel: document.getElementById('roboterwinkel').checked,
          auffaelligkeiten: document.getElementById('auffaelligkeiten').value.trim(),
          erstelltAm: new Date()
        };

        await db.collection('reinigungen').add(data);
        statusDiv.textContent = '‚úÖ Protokoll gespeichert!';
        statusDiv.className = 'success';

        Array.from(document.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = false);
        Array.from(document.querySelectorAll('input[type=number]')).forEach(nb => nb.value = '');
        document.getElementById('auffaelligkeiten').value = '';
        automatSelect.value = '';
        mitarbeiterSelect.value = '';
        pruefeFormular();
      } catch (error) {
        statusDiv.textContent = '‚ùå Fehler beim Speichern: ' + error.message;
        statusDiv.className = '';
        speichernBtn.disabled = false;
      }
    }

    ladeStaedte();
  </script>
</body>
</html>

