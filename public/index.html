<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reinigungsprotokoll Automaten</title>

  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg-top: #e3f2fd;
      --bg-main: #f4f6fb;
      --card-bg: #ffffff;
      --accent: #1e88e5;
      --accent-soft: #bbdefb;
      --accent-strong: #0d47a1;
      --success: #4caf50;
      --text-main: #212121;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 20px 10px 46px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-main) 40%, #ffffff 100%);
      color: var(--text-main);
      font-size: 18px;
    }

    .page { max-width: 900px; margin: 0 auto; }

    h1 {
      font-size: 20px;
      margin: 4px 4px 0;
      color: var(--accent-strong);
    }

    h2 {
      font-size: 15px;
      margin: 0 4px 14px;
      color: #455a64;
      font-weight: 500;
    }

    .section {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 20px 20px 22px;
      margin: 14px 4px;
      box-shadow: 0 2px 6px rgba(13, 71, 161, 0.10);
      border: 1px solid var(--accent-soft);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent-strong);
    }

    .section-badge {
      font-size: 14px;
      padding: 5px 14px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
    }

    label {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 2px;
      color: #455a64;
    }

    select, input[type="date"], input[type="number"], textarea {
      width: 100%;
      padding: 14px 15px;
      margin: 2px 0 0;
      border-radius: 12px;
      border: 1px solid #cfd8dc;
      font-size: 16px;
      background: #fafafa;
    }

    select:disabled { background: #eceff1; color: #90a4ae; }
    textarea { resize: vertical; min-height: 70px; }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }

    .task-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 14px;
      border-radius: 14px;
      background: #fafafa;
      border: 1px solid #eceff1;
    }

    .task-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      accent-color: var(--accent);
      flex-shrink: 0;
    }

    .task-label { flex: 1; font-size: 18px; }

    .stock-grid {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 10px;
    }

    .stock-field { display: flex; flex-direction: column; }

    .order-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }

    .order-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 13px 14px;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(76, 175, 80, 0.35);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-weight: 500;
    }

    .order-btn.ordered {
      background: var(--accent);
      box-shadow: 0 3px 6px rgba(30, 136, 229, 0.4);
    }

    button.main {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: var(--accent);
      color: white;
      padding: 14px 27px;
      border: none;
      border-radius: 999px;
      font-size: 18px;
      cursor: pointer;
      margin: 20px 4px 0;
      box-shadow: 0 3px 6px rgba(30, 136, 229, 0.35);
    }

    button.main:disabled { background: #b0bec5; box-shadow: none; cursor: not-allowed; }

    #status { margin: 16px 4px 0; font-size: 16px; }
    #status.ok { color: #1b5e20; }
    #status.err { color: #c62828; }

    @media (min-width: 700px) {
      .stock-grid { flex-direction: row; flex-wrap: wrap; }
      .stock-field { width: 48%; }
    }
  </style>
</head>
<body>

  <!-- PIN Gate -->
  <div id="pinGate" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#f5f7fb; z-index:9999;">
    <div style="background:#fff; border:1px solid #e0e4f0; border-radius:16px; padding:18px; width:340px; box-shadow:0 10px 25px rgba(15,23,42,0.08);">
      <div style="font-weight:900; font-size:18px; margin-bottom:8px; color:#0d47a1;">PIN erforderlich</div>
      <div style="color:#6b7280; font-size:13px; margin-bottom:10px;">Bitte PIN eingeben, um fortzufahren.</div>
      <input id="pinInput" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="PIN" style="width:100%; padding:10px 12px; border:1px solid #e0e4f0; border-radius:10px; font-size:14px;">
      <div id="pinError" style="color:#dc2626; font-size:12px; margin-top:8px; display:none;"></div>
      <button id="pinBtn" style="margin-top:12px; width:100%; padding:10px 12px; border-radius:10px; border:0; background:#1976d2; color:#fff; font-weight:900; cursor:pointer;">
        Einloggen
      </button>
    </div>
  </div>

  <div class="page">
    <h1>Reinigungsprotokoll Automaten</h1>
    <h2>Automatenservice Schiemann &amp; Automatenservice Albrecht</h2>

    <!-- 1. Automat ausw√§hlen -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">1. Automat ausw√§hlen</div>
        <div class="section-badge">Pflichtangaben</div>
      </div>
      <div class="field-group">
        <div><label for="stadtSelect">Stadt</label><select id="stadtSelect"><option>W√§hle Stadt...</option></select></div>
        <div><label for="centerSelect">Center</label><select id="centerSelect" disabled><option>W√§hle Center...</option></select></div>
        <div><label for="automatSelect">Automat</label><select id="automatSelect" disabled><option>W√§hle Automat...</option></select></div>
        <div><label for="datum">Datum</label><input type="date" id="datum" /></div>
        <div><label for="mitarbeiterSelect">Mitarbeiter / Leitung</label><select id="mitarbeiterSelect" disabled><option>Mitarbeiter w√§hlen...</option></select></div>
      </div>
    </div>

    <!-- 2. Aufgaben pro Automat -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">2. Aufgaben pro Automat</div>
        <div class="section-badge">Ankreuzen</div>
      </div>
      <div class="task-list">
        <div class="task-row"><input type="checkbox" id="zucker"><div class="task-label">Zucker aufgef√ºllt</div></div>
        <div class="task-row"><input type="checkbox" id="wasser"><div class="task-label">Wasser aufgef√ºllt</div></div>
        <div class="task-row"><input type="checkbox" id="staebeAuf"><div class="task-label">St√§be aufgef√ºllt</div></div>
        <div class="task-row"><input type="checkbox" id="zuckerfach"><div class="task-label">Zuckerfach gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="faecher"><div class="task-label">Alle F√§cher gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="abwasser"><div class="task-label">Abwasser entleert</div></div>
        <div class="task-row"><input type="checkbox" id="produktionsraum"><div class="task-label">Produktionsraum gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="messer"><div class="task-label">Messer + R√§dchen gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="roboterarm"><div class="task-label">Roboterarm gr√ºndlich gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="sieb"><div class="task-label">Sieb oben gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="auffangschale"><div class="task-label">Auffangschale gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="aufbewahrung"><div class="task-label">Aufbewahrungsfach aufger√§umt</div></div>
        <div class="task-row"><input type="checkbox" id="aussen"><div class="task-label">Automat au√üen gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="scheiben"><div class="task-label">Scheiben gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="brennerkopf"><div class="task-label">Brennerkopf gereinigt</div></div>
        <div class="task-row"><input type="checkbox" id="duese"><div class="task-label">D√ºse hinter Brennerkopf gereinigt</div></div>
      </div>
    </div>

    <!-- 3. Best√§nde -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">3. Best√§nde pro Packung</div>
        <div class="section-badge">F√ºllst√§nde</div>
      </div>
      <div class="stock-grid">
        <div class="stock-field"><label for="zucker_rot">Roter Zucker</label><input type="number" id="zucker_rot" step="0.5"></div>
        <div class="stock-field"><label for="zucker_gelb">Gelber Zucker</label><input type="number" id="zucker_gelb" step="0.5"></div>
        <div class="stock-field"><label for="zucker_blau">Blauer Zucker</label><input type="number" id="zucker_blau" step="0.5"></div>
        <div class="stock-field"><label for="zucker_weiss">Wei√üer Zucker</label><input type="number" id="zucker_weiss" step="0.5"></div>
        <div class="stock-field"><label for="zucker_weinrot">Weinrot</label><input type="number" id="zucker_weinrot" step="0.5"></div>
        <div class="stock-field"><label for="zucker_gruen">Gr√ºn</label><input type="number" id="zucker_gruen" step="0.5"></div>
        <div class="stock-field"><label for="staebe">St√§be (Pakete)</label><input type="number" id="staebe" step="0.5"></div>
      </div>
    </div>

    <!-- 3.5 Bestellungen -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">3.5 Bestellungen</div>
        <div class="section-badge">Sofortbestellen</div>
      </div>
      <div class="order-buttons">
        <button class="order-btn" id="btn-erdbeere" onclick="toggleBestellung('erdbeere')">üçì Rot (2 T√ºten)</button>
        <button class="order-btn" id="btn-vanille"  onclick="toggleBestellung('vanille')">üç≠ Gelb (2 T√ºten)</button>
        <button class="order-btn" id="btn-blaubeere"onclick="toggleBestellung('blaubeere')">ü´ê Blau (2 T√ºten)</button>
        <button class="order-btn" id="btn-normal"  onclick="toggleBestellung('normal')">üç≠ Wei√ü (2 T√ºten)</button>
        <button class="order-btn" id="btn-apfel"   onclick="toggleBestellung('apfel')">üçè Gr√ºn (2 T√ºten)</button>
        <button class="order-btn" id="btn-kirsch"  onclick="toggleBestellung('kirsch')">üçí Weinrot (2 T√ºten)</button>
        <button class="order-btn" id="btn-staebe"  onclick="toggleStaebe()">üßä St√§be (2 Pakete)</button>
      </div>
    </div>

    <!-- 4. Funktionspr√ºfung -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">4. Funktionspr√ºfung</div>
        <div class="section-badge">Testl√§ufe</div>
      </div>
      <div class="task-list">
        <div class="task-row">
          <input type="checkbox" id="befeuchtung">
          <div class="task-label">Befeuchtungstest</div>
        </div>
        <div class="task-row">
          <input type="checkbox" id="reinigungstest">
          <div class="task-label">Reinigungstest</div>
        </div>
        <div class="task-row">
          <input type="checkbox" id="neuer_stab">
          <div class="task-label">Neuen Stab genommen</div>
        </div>
        <div class="task-row">
          <input type="checkbox" id="roboterarm_90grad">
          <div class="task-label">Roboterarm im 90¬∞‚ÄëWinkel</div>
        </div>
        <div class="task-row">
          <input type="checkbox" id="kreditkarte_ok">
          <div class="task-label">Kreditkartensystem OK</div>
        </div>
        <div class="task-row">
          <input type="checkbox" id="geldschein_ok">
          <div class="task-label">Geldschein‚ÄëSystem OK</div>
        </div>
        <div class="task-row">
          <input type="checkbox" id="material_eingetragen">
          <div class="task-label">Material im System eingetragen</div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <label for="auffaelligkeiten">Auff√§lligkeiten</label>
        <textarea id="auffaelligkeiten" placeholder="Alles ok oder Probleme notieren..."></textarea>
      </div>
    </div>

    <button class="main" id="speichernBtn" disabled onclick="speichernProtokoll()">‚úÖ Protokoll speichern</button>
    <div id="status"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBo-pt3krDP9c5AxojmWaHVqPkoqmupOvA",
      authDomain: "digitales-bordbuch.firebaseapp.com",
      projectId: "digitales-bordbuch",
      storageBucket: "digitales-bordbuch.firebasestorage.app",
      messagingSenderId: "612073997080",
      appId: "1:612073997080:web:762cec6c160eab6f84546d",
      measurementId: "G-509LRCRV66"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---------------- PIN Gate ----------------
    // Zwingt immer zur PIN-Eingabe (f√ºr live Betrieb empfohlen)
    const ALWAYS_REQUIRE_PIN = true;   // true = bei jedem √ñffnen fragen
    const PIN_TTL_MS = 8 * 60 * 60 * 1000; // nur relevant wenn ALWAYS_REQUIRE_PIN = false

    function showPinError(msg) {
      const el = document.getElementById("pinError");
      el.textContent = msg;
      el.style.display = "block";
    }

    function hidePinGate() {
      const gate = document.getElementById("pinGate");
      if (gate) gate.style.display = "none";
    }

    // Liefert Array erlaubter St√§dte oder null (= alle)
    function getAllowedCitiesFromPinUser(pinUser) {
      if (!pinUser) return null;
      // bevorzugt: staedte: ["Berlin", "Hamburg"]
      if (Array.isArray(pinUser.staedte) && pinUser.staedte.length) {
        return pinUser.staedte.map(s => String(s).trim()).filter(Boolean);
      }
      // alternativ: stadt: "Berlin"
      if (pinUser.stadt) return [String(pinUser.stadt).trim()].filter(Boolean);
      return null;
    }

    async function requirePinOrStart(startAppFn) {
      const cached = JSON.parse(localStorage.getItem("pinAuth") || "null");

      if (!ALWAYS_REQUIRE_PIN && cached?.ok && cached?.until > Date.now()) {
        window.pinUser = cached.user || null;
        hidePinGate();
        startAppFn();
        return;
      }

      const btn = document.getElementById("pinBtn");
      const input = document.getElementById("pinInput");

      const attempt = async () => {
        const pin = (input.value || "").trim();
        if (!pin) return showPinError("Bitte PIN eingeben.");

        btn.disabled = true;
        btn.textContent = "Pr√ºfe‚Ä¶";
        document.getElementById("pinError").style.display = "none";

        try {
          // pins: Docs haben Felder { name, pin, ... optional staedte }
          const snap = await db.collection("pins").where("pin", "==", pin).limit(1).get();
          if (snap.empty) {
            showPinError("PIN falsch.");
            return;
          }

          const doc = snap.docs[0];
          const user = { id: doc.id, ...doc.data() };
          window.pinUser = user;

          localStorage.setItem("pinAuth", JSON.stringify({
            ok: true,
            until: Date.now() + PIN_TTL_MS,
            user
          }));

          hidePinGate();
          startAppFn();
        } catch (e) {
          showPinError("Fehler beim PIN-Check: " + (e.message || e));
        } finally {
          btn.disabled = false;
          btn.textContent = "Einloggen";
        }
      };

      btn.addEventListener("click", attempt);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") attempt();
      });

      // UX: Fokus direkt in PIN
      setTimeout(() => input.focus(), 50);
    }


    const stadtSelect = document.getElementById('stadtSelect');
    const centerSelect = document.getElementById('centerSelect');
    const automatSelect = document.getElementById('automatSelect');
    const mitarbeiterSelect = document.getElementById('mitarbeiterSelect');
    const datumInput = document.getElementById('datum');
    const speichernBtn = document.getElementById('speichernBtn');
    const statusDiv = document.getElementById('status');

    let unsubscribeBestellungen = null;

    const heute = new Date().toISOString().split('T')[0];
    datumInput.value = heute;

    function clearSelect(sel){ sel.innerHTML=''; }
    function addOption(sel,text,val){ const o=document.createElement('option');o.textContent=text;o.value=val;sel.appendChild(o); }

    async function ladeStaedte(){
      clearSelect(stadtSelect); addOption(stadtSelect,'W√§hle Stadt...','');
      const snap = await db.collection('automaten').get();
      const set = new Set();
      snap.forEach(d => { if(d.data().stadt) set.add(String(d.data().stadt).trim()); });
            const allowed = getAllowedCitiesFromPinUser(window.pinUser);
      const cities = Array.from(set).filter(s => !allowed || allowed.includes(s));
      cities.sort().forEach(s => addOption(stadtSelect,s,s));
Array.from(set).sort().forEach(s => addOption(stadtSelect,s,s));
      stadtSelect.disabled=false; centerSelect.disabled=true; automatSelect.disabled=true; mitarbeiterSelect.disabled=true;
      pruefeFormular();
    }

    async function ladeCenter(stadt){
      clearSelect(centerSelect); addOption(centerSelect,'W√§hle Center...','');
      centerSelect.disabled=true; automatSelect.disabled=true; mitarbeiterSelect.disabled=true;
      if(!stadt){ pruefeFormular(); return; }
      const allowed = getAllowedCitiesFromPinUser(window.pinUser);
      if (allowed && !allowed.includes(stadt)) { pruefeFormular(); return; }
      const snap = await db.collection('automaten').where('stadt','==',stadt).get();
      snap.forEach(doc => { const c=doc.data().center; if(c) addOption(centerSelect,String(c),String(c)); });
      if(centerSelect.options.length>1) centerSelect.disabled=false;
      pruefeFormular();
    }

    async function ladeAutomatenUndMitarbeiter(stadt,center){
      clearSelect(automatSelect); addOption(automatSelect,'W√§hle Automat...','');
      clearSelect(mitarbeiterSelect); addOption(mitarbeiterSelect,'Mitarbeiter w√§hlen...','');
      automatSelect.disabled=true; mitarbeiterSelect.disabled=true;
      if(!stadt || !center){ pruefeFormular(); return; }
      const snap = await db.collection('automaten').where('stadt','==',stadt).where('center','==',center).get();
      const pinName = window.pinUser && window.pinUser.name ? String(window.pinUser.name).trim() : "";
      snap.forEach(doc=>{
        const d=doc.data();
        const code=(d.automatCode || d.Automat || '').toString().trim();
        if(code) addOption(automatSelect,code,code);
      });

      // Mitarbeiter: aus PIN ableiten (verhindert "Name faken")
      if (pinName) {
        addOption(mitarbeiterSelect, pinName, pinName);
      } else {
        // Fallback: wenn kein Name im PIN-Dokument, dann wie fr√ºher aus Daten
        const mitSet = new Set();
        snap.forEach(doc=>{
          const d=doc.data();
          if(d.mitarbeiter) mitSet.add(String(d.mitarbeiter).trim());
          if(d.leitung) mitSet.add(String(d.leitung).trim());
        });
        mitSet.add('Klaus Schiemann');
        mitSet.add('Dirk Albrecht');
        Array.from(mitSet).filter(Boolean).sort().forEach(m=>addOption(mitarbeiterSelect,m,m));
      }
      if(automatSelect.options.length>1) automatSelect.disabled=false;
      if(mitarbeiterSelect.options.length>1) {
        mitarbeiterSelect.disabled = false;
        // auto-select first available
        if (!mitarbeiterSelect.value) mitarbeiterSelect.selectedIndex = 1;
        // wenn PIN-Name gesetzt, Auswahl sperren
        const pinName = window.pinUser && window.pinUser.name ? String(window.pinUser.name).trim() : "";
        if (pinName) mitarbeiterSelect.disabled = true;
      }
      pruefeFormular();
      ladeBestellungen();
    }

    function pruefeFormular(){
      const ok = stadtSelect.value && centerSelect.value && automatSelect.value && mitarbeiterSelect.value && datumInput.value;
      speichernBtn.disabled = !ok;
    }

    stadtSelect.addEventListener('change',()=>{ladeCenter(stadtSelect.value);});
    centerSelect.addEventListener('change',()=>{ladeAutomatenUndMitarbeiter(stadtSelect.value,centerSelect.value);});
    automatSelect.addEventListener('change',()=>{pruefeFormular();ladeBestellungen();});
    mitarbeiterSelect.addEventListener('change',pruefeFormular);
    datumInput.addEventListener('change',pruefeFormular);

    function setButtonState(id,on){
      const b=document.getElementById(id);
      if(!b)return;
      on?b.classList.add('ordered'):b.classList.remove('ordered');
    }

    function ladeBestellungen(){
      if(unsubscribeBestellungen){unsubscribeBestellungen();unsubscribeBestellungen=null;}
      document.querySelectorAll('.order-btn').forEach(b=>b.classList.remove('ordered'));
      const code = automatSelect.value || '';
      if(!code) return;
      const q = db.collection('bestellungen')
        .where('automat','==',code)
        .where('status','==','bestellt')
        .orderBy('timestamp','desc');
      unsubscribeBestellungen = q.onSnapshot(snap=>{
        snap.forEach(doc=>{
          const d=doc.data();
          if(d.farbe) setButtonState('btn-'+d.farbe,true);
          else if(d.typ==='St√§be') setButtonState('btn-staebe',true);
        });
      });
    }

    window.toggleBestellung = async function(sorte){
      const btnId='btn-'+sorte;
      const btn=document.getElementById(btnId);
      if(!btn || !automatSelect.value) return;
      const istBestellt = btn.classList.contains('ordered');
      try{
        const basis = {
          farbe:sorte,
          typ:'Zucker',
          menge:'2 T√ºten',
          automat:automatSelect.value,
          stadt:stadtSelect.value,
          center:centerSelect.value,
          mitarbeiter:mitarbeiterSelect.value,
          timestamp:new Date()
        };
        if(!istBestellt){
          await db.collection('bestellungen').add({...basis,status:'bestellt'});
          setButtonState(btnId,true);
        }else{
          await db.collection('bestellungen').add({...basis,status:'storniert'});
          setButtonState(btnId,false);
        }
      }catch(e){console.error(e);}
    };

    window.toggleStaebe = async function(){
      const btnId='btn-staebe';
      const btn=document.getElementById(btnId);
      if(!btn || !automatSelect.value) return;
      const istBestellt = btn.classList.contains('ordered');
      try{
        const basis = {
          typ:'St√§be',
          menge:'2 Pakete',
          automat:automatSelect.value,
          stadt:stadtSelect.value,
          center:centerSelect.value,
          mitarbeiter:mitarbeiterSelect.value,
          timestamp:new Date()
        };
        if(!istBestellt){
          await db.collection('bestellungen').add({...basis,status:'bestellt',staebeBestellt:2});
          setButtonState(btnId,true);
        }else{
          await db.collection('bestellungen').add({...basis,status:'storniert',staebeBestellt:-2});
          setButtonState(btnId,false);
        }
      }catch(e){console.error(e);}
    };

    async function speichernProtokoll(){
      if(speichernBtn.disabled) return;
      speichernBtn.disabled=true;
      statusDiv.textContent='Speichere‚Ä¶';
      statusDiv.className='';
      try{
        const data = {
          automatCode: automatSelect.value,
          stadt: stadtSelect.value,
          center: centerSelect.value,
          datum: new Date(datumInput.value),
          mitarbeiter: mitarbeiterSelect.value,

          // Punkt 2 ‚Äì Aufgaben
          zucker_aufgefuellt: document.getElementById('zucker').checked,
          wasser_aufgefuellt: document.getElementById('wasser').checked,
          staebe_aufgefuellt: document.getElementById('staebeAuf').checked,
          zuckerfach_gereinigt: document.getElementById('zuckerfach').checked,
          faecher_gereinigt: document.getElementById('faecher').checked,
          abwasser_entleert: document.getElementById('abwasser').checked,
          produktionsraum_gereinigt: document.getElementById('produktionsraum').checked,
          messer_gereinigt: document.getElementById('messer').checked,
          roboterarm_gereinigt: document.getElementById('roboterarm').checked,
          sieb_gereinigt: document.getElementById('sieb').checked,
          auffangschale_gereinigt: document.getElementById('auffangschale').checked,
          aufbewahrung_aufgeraeumt: document.getElementById('aufbewahrung').checked,
          automat_aussen_gereinigt: document.getElementById('aussen').checked,
          scheiben_gereinigt: document.getElementById('scheiben').checked,
          brennerkopf_gereinigt: document.getElementById('brennerkopf').checked,
          duese_gereinigt: document.getElementById('duese').checked,

          // Punkt 3 ‚Äì Best√§nde
          zucker_rot:   parseFloat(document.getElementById('zucker_rot').value)   || 0,
          zucker_gelb:  parseFloat(document.getElementById('zucker_gelb').value)  || 0,
          zucker_blau:  parseFloat(document.getElementById('zucker_blau').value)  || 0,
          zucker_weiss: parseFloat(document.getElementById('zucker_weiss').value) || 0,
          zucker_weinrot:parseFloat(document.getElementById('zucker_weinrot').value)||0,
          zucker_gruen: parseFloat(document.getElementById('zucker_gruen').value) || 0,
          staebe:       parseFloat(document.getElementById('staebe').value)       || 0,

          // Punkt 4 ‚Äì Funktionspr√ºfung
          befeuchtungstest:          document.getElementById('befeuchtung').checked,
          reinigungstest:           document.getElementById('reinigungstest').checked,
          neuer_stab_genommen:      document.getElementById('neuer_stab').checked,
          roboterarm_90grad:        document.getElementById('roboterarm_90grad').checked,
          kreditkartensystem_ok:    document.getElementById('kreditkarte_ok').checked,
          geldschein_system_ok:     document.getElementById('geldschein_ok').checked,
          material_im_system:       document.getElementById('material_eingetragen').checked,

          auffaelligkeiten: document.getElementById('auffaelligkeiten').value.trim(),
          erstelltAm: new Date()
        };

        await db.collection('reinigungen').add(data);
        statusDiv.textContent='‚úÖ Erfolgreich gespeichert';
        statusDiv.className='ok';
        setTimeout(()=>window.location.reload(),2000);
      }catch(err){
        statusDiv.textContent='‚ùå Fehler beim Speichern: '+err.message;
        statusDiv.className='err';
        speichernBtn.disabled=false;
      }
    }

    function startApp(){
      ladeStaedte();
    }

    requirePinOrStart(startApp);
  </script>
</body>
</html>
